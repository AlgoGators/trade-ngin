name: Code Coverage

on:
  push:
    branches: [ main, develop, main-hd ]
  pull_request:
    branches: [ main, develop, main-hd ]

jobs:
  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev nlohmann-json3-dev libpqxx-dev lcov gcovr
          # Install Arrow from source if not available in package manager
          if ! dpkg -l | grep -q libarrow; then
            echo "Installing Arrow from source..."
            wget https://archive.apache.org/dist/arrow/arrow-14.0.2/apache-arrow-14.0.2.tar.gz
            tar -xzf apache-arrow-14.0.2.tar.gz
            cd apache-arrow-14.0.2/cpp
            mkdir build && cd build
            cmake .. -DARROW_COMPUTE=ON -DARROW_CSV=ON -DARROW_DATASET=ON -DARROW_FILESYSTEM=ON -DARROW_JSON=ON -DARROW_PARQUET=ON
            make -j$(nproc)
            sudo make install
            sudo ldconfig
          fi

      - name: Configure CMake with Coverage
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-g -O0 -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="-fprofile-arcs -ftest-coverage"

      - name: Build Project
        run: |
          cd build
          make -j$(nproc)

      - name: Run Tests with Coverage
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Generate Coverage Data
        run: |
          cd build
          # Generate coverage data
          lcov --capture --directory . --output-file coverage.info
          
          # Remove external files from coverage
          lcov --remove coverage.info '/usr/*' '/opt/*' '*/tests/*' '*/externals/*' '*/build/*' --output-file coverage.info

      - name: Generate Coverage Reports
        run: |
          cd build
          # Generate HTML report
          genhtml coverage.info --output-directory coverage_html --title "Trade Ngin Coverage Report"
          
          # Generate XML report for GitHub
          gcovr --root .. --exclude tests --exclude externals --exclude build --xml --output coverage.xml
          
          # Generate detailed HTML report
          gcovr --root .. --exclude tests --exclude externals --exclude build --html --html-details --output coverage_detailed.html

      - name: Check Coverage Threshold
        run: |
          cd build
          # Extract coverage percentage
          COVERAGE_PERCENT=$(lcov --summary coverage.info | grep "lines......:" | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE_PERCENT%"
          
          # Set coverage as output for other jobs
          echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          
          # Check if coverage meets threshold
          if (( $(echo "$COVERAGE_PERCENT < 75" | bc -l) )); then
            echo "âŒ Coverage ($COVERAGE_PERCENT%) is below threshold (75%)"
            echo "coverage_status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… Coverage ($COVERAGE_PERCENT%) meets threshold (75%)"
            echo "coverage_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: build/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            build/coverage_html/
            build/coverage_detailed.html
            build/coverage.xml
            build/coverage.info

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coveragePercent = '${{ steps.coverage.outputs.coverage_percent }}';
            const coverageStatus = '${{ steps.coverage.outputs.coverage_status }}';
            
            const statusIcon = coverageStatus === 'passed' ? 'âœ…' : 'âŒ';
            const statusText = coverageStatus === 'passed' ? 'PASSED' : 'FAILED';
            
            const comment = `## Code Coverage Report
            
            ${statusIcon} **Coverage: ${coveragePercent}%** (Status: ${statusText})
            
            - Coverage threshold: 75%
            - Detailed reports available in artifacts
            - Coverage reports generated for all source files
            
            ${coverageStatus === 'failed' ? 'âš ï¸ Please add more tests to improve coverage.' : 'ðŸŽ‰ Coverage requirements met!'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create Coverage Badge
        run: |
          cd build
          COVERAGE_PERCENT=$(lcov --summary coverage.info | grep "lines......:" | awk '{print $3}' | sed 's/%//')
          
          # Create a simple badge (you can replace this with a proper badge service)
          echo "Coverage: $COVERAGE_PERCENT%" > coverage_badge.txt
          
          # For a proper badge, you would typically use a service like shields.io
          # echo "![Coverage](https://img.shields.io/badge/coverage-${COVERAGE_PERCENT}%25-brightgreen)" > coverage_badge.md

      - name: Upload Coverage Badge
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge-${{ github.run_number }}
          path: build/coverage_badge.txt 