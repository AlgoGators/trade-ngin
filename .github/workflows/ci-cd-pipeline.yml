name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, main-hd ]
  pull_request:
    branches: [ main, develop, main-hd ]

env:
  COVERAGE_THRESHOLD: 75

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cpplint

      - name: Run Clang Format Check
        run: |
          echo "Checking code formatting..."
          # Check for formatting issues but don't fail the pipeline
          FORMAT_ISSUES=0
          for file in $(find src include -name "*.cpp" -o -name "*.hpp"); do
            if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
              echo "âš ï¸  Formatting issues found in: $file"
              FORMAT_ISSUES=$((FORMAT_ISSUES + 1))
            fi
          done
          
          if [ $FORMAT_ISSUES -eq 0 ]; then
            echo "âœ… Code formatting is correct"
          else
            echo "âš ï¸  Found $FORMAT_ISSUES files with formatting issues (non-blocking)"
            echo "ðŸ’¡ To fix formatting issues, run: clang-format -i src/**/*.cpp include/**/*.hpp"
          fi

      - name: Run Cpplint
        run: |
          echo "Running cpplint..."
          cpplint --recursive --filter=-legal/copyright,-build/include_order src include || true
          echo "âœ… Linting completed"

      - name: Create Linting Report
        run: |
          mkdir -p linting
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPORT_FILE="linting/lint_report_$TIMESTAMP.txt"
          SUMMARY_FILE="linting/lint_summary_$TIMESTAMP.txt"
          
          echo "Linting Report - $(date)" > $REPORT_FILE
          echo "=================================" >> $REPORT_FILE
          
          # Initialize counters
          FORMAT_ISSUES=0
          STYLE_ISSUES=0
          TODO_COUNT=0
          FIXME_COUNT=0
          MEMORY_ISSUES=0
          SERIOUS_ISSUES=0
          
          echo "ðŸ” Checking code formatting..." >> $REPORT_FILE
          echo "Clang Format Check:" >> $REPORT_FILE
          
          # Check formatting issues
          for file in $(find src include -name "*.cpp" -o -name "*.hpp"); do
            if ! clang-format --dry-run "$file" >/dev/null 2>&1; then
              echo "Formatting issues in: $file" >> $REPORT_FILE
              FORMAT_ISSUES=$((FORMAT_ISSUES + 1))
            fi
          done
          
          if [ $FORMAT_ISSUES -eq 0 ]; then
            echo "âœ… No formatting issues found" >> $REPORT_FILE
          else
            echo "âš ï¸  Found $FORMAT_ISSUES files with formatting issues (COSMETIC)" >> $REPORT_FILE
          fi
          
          echo "" >> $REPORT_FILE
          echo "Cpplint Results:" >> $REPORT_FILE
          
          # Run cpplint and categorize issues
          CPPLINT_OUTPUT=$(cpplint --recursive --filter=-legal/copyright,-build/include_order src include 2>&1 || true)
          echo "$CPPLINT_OUTPUT" >> $REPORT_FILE
          
          # Count and categorize cpplint issues
          STYLE_ISSUES=$(echo "$CPPLINT_OUTPUT" | grep -c "Total errors found" || echo "0")
          
          # Check for serious issues
          echo "" >> $REPORT_FILE
          echo "Additional Security/Quality Checks:" >> $REPORT_FILE
          
          # Check for TODO comments
          TODO_COUNT=$(grep -r "TODO" src include | wc -l || echo "0")
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $TODO_COUNT TODO comments (DEVELOPMENT)" >> $REPORT_FILE
            grep -r "TODO" src include >> $REPORT_FILE || true
          fi
          
          # Check for FIXME comments
          FIXME_COUNT=$(grep -r "FIXME" src include | wc -l || echo "0")
          if [ "$FIXME_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $FIXME_COUNT FIXME comments (KNOWN ISSUES)" >> $REPORT_FILE
            grep -r "FIXME" src include >> $REPORT_FILE || true
          fi
          
          # Check for potential memory leaks (SERIOUS)
          MEMORY_ISSUES=$(grep -r "new.*delete\|malloc.*free" src include | wc -l || echo "0")
          if [ "$MEMORY_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $MEMORY_ISSUES potential memory management issues (SERIOUS)" >> $REPORT_FILE
            grep -r "new.*delete\|malloc.*free" src include >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + MEMORY_ISSUES))
          fi
          
          # Check for hardcoded credentials (SERIOUS)
          CREDENTIAL_ISSUES=$(grep -r "password\|secret\|key" src include | wc -l || echo "0")
          if [ "$CREDENTIAL_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $CREDENTIAL_ISSUES potential hardcoded credentials (SERIOUS)" >> $REPORT_FILE
            grep -r "password\|secret\|key" src include >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + CREDENTIAL_ISSUES))
          fi
          
          # Check for security vulnerabilities (SERIOUS)
          SECURITY_ISSUES=$(find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" | wc -l || echo "0")
          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $SECURITY_ISSUES potential security vulnerabilities (SERIOUS)" >> $REPORT_FILE
            find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + SECURITY_ISSUES))
          fi
          
          # Create summary file
          echo "Linting Summary - $(date)" > $SUMMARY_FILE
          echo "===============================" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸ“Š Issue Categories:" >> $SUMMARY_FILE
          echo "===================" >> $SUMMARY_FILE
          echo "ðŸŽ¨ COSMETIC (Formatting/Style):" >> $SUMMARY_FILE
          echo "   - Formatting issues: $FORMAT_ISSUES" >> $SUMMARY_FILE
          echo "   - Style guide violations: $STYLE_ISSUES" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸ”§ DEVELOPMENT (Work in Progress):" >> $SUMMARY_FILE
          echo "   - TODO comments: $TODO_COUNT" >> $SUMMARY_FILE
          echo "   - FIXME comments: $FIXME_COUNT" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸš¨ SERIOUS (Security/Quality):" >> $SUMMARY_FILE
          echo "   - Memory management issues: $MEMORY_ISSUES" >> $SUMMARY_FILE
          echo "   - Hardcoded credentials: $CREDENTIAL_ISSUES" >> $SUMMARY_FILE
          echo "   - Security vulnerabilities: $SECURITY_ISSUES" >> $SUMMARY_FILE
          echo "   - Total serious issues: $SERIOUS_ISSUES" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          
          if [ $SERIOUS_ISSUES -gt 0 ]; then
            echo "âŒ ATTENTION: $SERIOUS_ISSUES serious issues found!" >> $SUMMARY_FILE
            echo "   These should be addressed before merging." >> $SUMMARY_FILE
          else
            echo "âœ… No serious issues found." >> $SUMMARY_FILE
          fi
          
          if [ $FORMAT_ISSUES -gt 0 ] || [ $STYLE_ISSUES -gt 0 ]; then
            echo "âš ï¸  $FORMAT_ISSUES formatting + $STYLE_ISSUES style issues (cosmetic)" >> $SUMMARY_FILE
            echo "   These can be fixed with: clang-format -i src/**/*.cpp include/**/*.hpp" >> $SUMMARY_FILE
          else
            echo "âœ… No cosmetic issues found." >> $SUMMARY_FILE
          fi

      - name: Upload Linting Report
        uses: actions/upload-artifact@v4
        with:
          name: linting-report-${{ github.run_number }}
          path: linting/
          
      - name: Upload Linting Summary
        uses: actions/upload-artifact@v4
        with:
          name: linting-summary-${{ github.run_number }}
          path: linting/lint_summary_*.txt

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        build-type: [Debug, Release]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev nlohmann-json3-dev libpqxx-dev
          # Install Arrow from source if not available in package manager
          if ! dpkg -l | grep -q libarrow; then
            echo "Installing Arrow from source..."
            wget https://archive.apache.org/dist/arrow/arrow-14.0.2/apache-arrow-14.0.2.tar.gz
            tar -xzf apache-arrow-14.0.2.tar.gz
            cd apache-arrow-14.0.2/cpp
            mkdir build && cd build
            cmake .. -DARROW_COMPUTE=ON -DARROW_CSV=ON -DARROW_DATASET=ON -DARROW_FILESYSTEM=ON -DARROW_JSON=ON -DARROW_PARQUET=ON
            make -j$(nproc)
            sudo make install
            sudo ldconfig
          fi

      - name: Configure CMake with Coverage
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DCMAKE_CXX_FLAGS="${{ matrix.build-type == 'Debug' && '-g -O0 -fprofile-arcs -ftest-coverage' || '-O3' }}" \
            -DCMAKE_EXE_LINKER_FLAGS="${{ matrix.build-type == 'Debug' && '-fprofile-arcs -ftest-coverage' || '' }}"

      - name: Build Project
        run: |
          cd build
          make -j$(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Generate Coverage Report
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          # Generate coverage data
          lcov --capture --directory . --output-file coverage.info
          
          # Remove external files from coverage
          lcov --remove coverage.info '/usr/*' '/opt/*' '*/tests/*' '*/externals/*' --output-file coverage.info
          
          # Generate HTML report
          genhtml coverage.info --output-directory coverage_html
          
          # Generate XML report for GitHub
          gcovr --root .. --exclude tests --exclude externals --xml --output coverage.xml

      - name: Check Coverage Threshold
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          # Extract coverage percentage
          COVERAGE_PERCENT=$(lcov --summary coverage.info | grep "lines......:" | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE_PERCENT%"
          
          # Check if coverage meets threshold
          if (( $(echo "$COVERAGE_PERCENT < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "âŒ Coverage ($COVERAGE_PERCENT%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
            exit 1
          else
            echo "âœ… Coverage ($COVERAGE_PERCENT%) meets threshold (${{ env.COVERAGE_THRESHOLD }}%)"
          fi

      - name: Upload Coverage Reports
        if: matrix.build-type == 'Debug'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            build/coverage_html/
            build/coverage.xml
            build/coverage.info

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}-${{ matrix.build-type }}
          path: build/Testing/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Security Scan
        run: |
          echo "Running basic security checks..."
          # Check for common security issues in C++ code
          find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" || echo "No obvious security issues found"
          
          # Check for hardcoded credentials
          grep -r "password\|secret\|key" src include || echo "No obvious hardcoded credentials found"

  report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [lint, build, security-scan]
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: coverage-reports/

      - name: Download Linting Reports
        uses: actions/download-artifact@v4
        with:
          name: linting-report-${{ github.run_number }}
          path: linting-reports/

      - name: Generate Summary
        run: |
          echo "# CI/CD Pipeline Summary" > summary.md
          echo "## Build Status" >> summary.md
          echo "- Linting: ${{ needs.lint.result }}" >> summary.md
          echo "- Build: ${{ needs.build.result }}" >> summary.md
          echo "- Security: ${{ needs.security-scan.result }}" >> summary.md
          
          if [ -f "coverage-reports/coverage.xml" ]; then
            echo "## Coverage Report" >> summary.md
            echo "Coverage report is available in the artifacts." >> summary.md
          fi
          
          if [ -d "linting-reports/" ]; then
            echo "## Linting Report" >> summary.md
            echo "Linting report is available in the artifacts." >> summary.md
          fi

      - name: Upload Summary Report
        uses: actions/upload-artifact@v4
        with:
          name: summary-report-${{ github.run_number }}
          path: summary.md 