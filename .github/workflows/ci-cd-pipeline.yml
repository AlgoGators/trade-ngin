name: CI/CD Pipeline

on:
  push:
    branches:
      [
        main,
        develop,
        main-hd,
        formatting-test,
        unit-testing-and-ci-cd-pipeline-updates,
      ]
  pull_request:
    branches: [main, develop, main-hd]

env:
  COVERAGE_THRESHOLD: 30

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/algogators/trade-ngin-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Run Clang Format Check
        run: |
          echo "Checking code formatting..."
          # Check for formatting issues but don't fail the pipeline
          FORMAT_ISSUES=0
          for file in $(find src include -name "*.cpp" -o -name "*.hpp"); do
            if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
              echo "âš ï¸  Formatting issues found in: $file"
              FORMAT_ISSUES=$((FORMAT_ISSUES + 1))
            fi
          done

          if [ $FORMAT_ISSUES -eq 0 ]; then
            echo "âœ… Code formatting is correct"
          else
            echo "âš ï¸  Found $FORMAT_ISSUES files with formatting issues (non-blocking)"
            echo "ðŸ’¡ To fix formatting issues, run: clang-format -i src/**/*.cpp include/**/*.hpp"
          fi
      - name: Run Clang Tidy Check
        run: |
          echo "Running clang-tidy static analysis..."
          mkdir -p build
          cd build
          cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Run clang-tidy on all source files and output to report
          find ../src -name "*.cpp" | xargs -P$(nproc) -n1 clang-tidy -p . --format-style=file 2>&1 | tee ../clang-tidy-report.txt || true

          echo "âœ… Clang-tidy analysis completed"
          echo "ðŸ“„ Report saved to clang-tidy-report.txt"

      - name: Run Cppcheck
        run: |
          echo "Running cppcheck static analysis..."
          cppcheck --enable=all --suppress=missingInclude --quiet \
            --error-exitcode=0 --xml --xml-version=2 \
            src include 2> cppcheck-report.xml || true

          # Generate text report
          cppcheck --enable=all --suppress=missingInclude \
            src include 2>&1 | tee cppcheck-report.txt || true

          echo "âœ… Cppcheck analysis completed"
      - name: Run Cpplint
        run: |
          echo "Running cpplint..."
          cpplint --recursive --filter=-legal/copyright,-build/include_order src include || true
          echo "âœ… Linting completed"

      - name: Create Linting Report
        run: |
          mkdir -p linting
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPORT_FILE="linting/lint_report_$TIMESTAMP.txt"
          SUMMARY_FILE="linting/lint_summary_$TIMESTAMP.txt"

          echo "Linting Report - $(date)" > $REPORT_FILE
          echo "=================================" >> $REPORT_FILE

          # Initialize counters
          FORMAT_ISSUES=0
          STYLE_ISSUES=0
          TODO_COUNT=0
          FIXME_COUNT=0
          MEMORY_ISSUES=0
          SERIOUS_ISSUES=0

          echo "ðŸ” Checking code formatting..." >> $REPORT_FILE
          echo "Clang Format Check:" >> $REPORT_FILE

          # Check formatting issues
          for file in $(find src include -name "*.cpp" -o -name "*.hpp"); do
            if ! clang-format --dry-run "$file" >/dev/null 2>&1; then
              echo "Formatting issues in: $file" >> $REPORT_FILE
              FORMAT_ISSUES=$((FORMAT_ISSUES + 1))
            fi
          done

          if [ $FORMAT_ISSUES -eq 0 ]; then
            echo "âœ… No formatting issues found" >> $REPORT_FILE
          else
            echo "âš ï¸  Found $FORMAT_ISSUES files with formatting issues (COSMETIC)" >> $REPORT_FILE
          fi

          echo "" >> $REPORT_FILE
          echo "Cpplint Results:" >> $REPORT_FILE

          # Add clang-tidy results to report
          echo "" >> $REPORT_FILE
          echo "Clang Tidy Results:" >> $REPORT_FILE
          echo "===================" >> $REPORT_FILE
          if [ -f "clang-tidy-report.txt" ]; then
          cat clang-tidy-report.txt >> $REPORT_FILE
          else
          echo "No clang-tidy report found" >> $REPORT_FILE
          fi

          # Run cpplint and categorize issues
          CPPLINT_OUTPUT=$(cpplint --recursive --filter=-legal/copyright,-build/include_order src include 2>&1 || true)
          echo "$CPPLINT_OUTPUT" >> $REPORT_FILE

          # Count and categorize cpplint issues
          STYLE_ISSUES=$(echo "$CPPLINT_OUTPUT" | grep -c "Total errors found" || echo "0")

          # Check for serious issues
          echo "" >> $REPORT_FILE
          echo "Additional Security/Quality Checks:" >> $REPORT_FILE

          # Check for TODO comments
          TODO_COUNT=$(grep -r "TODO" src include | wc -l || echo "0")
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $TODO_COUNT TODO comments (DEVELOPMENT)" >> $REPORT_FILE
            grep -r "TODO" src include >> $REPORT_FILE || true
          fi

          # Check for FIXME comments
          FIXME_COUNT=$(grep -r "FIXME" src include | wc -l || echo "0")
          if [ "$FIXME_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $FIXME_COUNT FIXME comments (KNOWN ISSUES)" >> $REPORT_FILE
            grep -r "FIXME" src include >> $REPORT_FILE || true
          fi

          # Check for potential memory leaks (SERIOUS)
          MEMORY_ISSUES=$(grep -r "new.*delete\|malloc.*free" src include | wc -l || echo "0")
          if [ "$MEMORY_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $MEMORY_ISSUES potential memory management issues (SERIOUS)" >> $REPORT_FILE
            grep -r "new.*delete\|malloc.*free" src include >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + MEMORY_ISSUES))
          fi

          # Check for hardcoded credentials (SERIOUS)
          CREDENTIAL_ISSUES=$(grep -r "password\|secret\|key" src include | wc -l || echo "0")
          if [ "$CREDENTIAL_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $CREDENTIAL_ISSUES potential hardcoded credentials (SERIOUS)" >> $REPORT_FILE
            grep -r "password\|secret\|key" src include >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + CREDENTIAL_ISSUES))
          fi

          # Check for security vulnerabilities (SERIOUS)
          SECURITY_ISSUES=$(find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" | wc -l || echo "0")
          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "ðŸš¨ Found $SECURITY_ISSUES potential security vulnerabilities (SERIOUS)" >> $REPORT_FILE
            find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" >> $REPORT_FILE || true
            SERIOUS_ISSUES=$((SERIOUS_ISSUES + SECURITY_ISSUES))
          fi

          # Create summary file
          echo "Linting Summary - $(date)" > $SUMMARY_FILE
          echo "===============================" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸ“Š Issue Categories:" >> $SUMMARY_FILE
          echo "===================" >> $SUMMARY_FILE
          echo "ðŸŽ¨ COSMETIC (Formatting/Style):" >> $SUMMARY_FILE
          echo "   - Formatting issues: $FORMAT_ISSUES" >> $SUMMARY_FILE
          echo "   - Style guide violations: $STYLE_ISSUES" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸ”§ DEVELOPMENT (Work in Progress):" >> $SUMMARY_FILE
          echo "   - TODO comments: $TODO_COUNT" >> $SUMMARY_FILE
          echo "   - FIXME comments: $FIXME_COUNT" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸš¨ SERIOUS (Security/Quality):" >> $SUMMARY_FILE
          echo "   - Memory management issues: $MEMORY_ISSUES" >> $SUMMARY_FILE
          echo "   - Hardcoded credentials: $CREDENTIAL_ISSUES" >> $SUMMARY_FILE
          echo "   - Security vulnerabilities: $SECURITY_ISSUES" >> $SUMMARY_FILE
          echo "   - Total serious issues: $SERIOUS_ISSUES" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "ðŸ” Static Analysis (clang-tidy):" >> $SUMMARY_FILE
          if [ -f "clang-tidy-report.txt" ]; then
          CLANG_TIDY_ISSUES=$(grep -c "warning\|error" clang-tidy-report.txt || echo "0")
          echo "   - Static analysis issues: $CLANG_TIDY_ISSUES" >> $SUMMARY_FILE
          else
          echo "   - Static analysis: No report generated" >> $SUMMARY_FILE
          fi

          if [ $SERIOUS_ISSUES -gt 0 ]; then
            echo "âŒ ATTENTION: $SERIOUS_ISSUES serious issues found!" >> $SUMMARY_FILE
            echo "   These should be addressed before merging." >> $SUMMARY_FILE
          else
            echo "âœ… No serious issues found." >> $SUMMARY_FILE
          fi

          if [ $FORMAT_ISSUES -gt 0 ] || [ $STYLE_ISSUES -gt 0 ]; then
            echo "âš ï¸  $FORMAT_ISSUES formatting + $STYLE_ISSUES style issues (cosmetic)" >> $SUMMARY_FILE
            echo "   These can be fixed with: clang-format -i src/**/*.cpp include/**/*.hpp" >> $SUMMARY_FILE
          else
            echo "âœ… No cosmetic issues found." >> $SUMMARY_FILE
          fi

      - name: Upload Linting Report
        uses: actions/upload-artifact@v4
        with:
          name: linting-report-${{ github.run_number }}
          path: linting/

      - name: Upload Linting Summary
        uses: actions/upload-artifact@v4
        with:
          name: linting-summary-${{ github.run_number }}
          path: linting/lint_summary_*.txt

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/algogators/trade-ngin-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    needs: lint
    strategy:
      matrix:
        build-type: [Debug, Release]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Configure CMake with Coverage
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_COMPILER=${{ matrix.build-type == 'Debug' && 'g++' || 'g++' }} \
            -DCMAKE_CXX_FLAGS="${{ matrix.build-type == 'Debug' && '-g -O0 --coverage' || '-O3' }}" \
            -DCMAKE_EXE_LINKER_FLAGS="${{ matrix.build-type == 'Debug' && '--coverage' || '' }}"

      - name: Build Project
        run: |
          cd build
          make -j$(nproc)

      - name: Run Valgrind Memory Check
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          # Run tests with Valgrind
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            --error-exitcode=1 ctest --output-on-failure --verbose

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Generate Coverage Report
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          # Generate coverage data
          lcov --capture --directory . --output-file coverage.info --ignore-errors mismatch --ignore-errors negative

          # Only use files in the src directory
          lcov --extract coverage.info '*/src/*' --output-file coverage.info --ignore-errors unused

          # Generate HTML report
          genhtml coverage.info --output-directory coverage_html

          # Generate XML report for GitHub
          gcovr --root .. --filter '../src/.*' --xml --output coverage.xml

      - name: Check Coverage Threshold
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          # Extract coverage percentage (get the number before the %)
          COVERAGE_PERCENT=$(lcov --summary coverage.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)')
          echo "Coverage: $COVERAGE_PERCENT%"

          # Check if coverage meets threshold using awk instead of bc
          if [ $(awk -v cov="$COVERAGE_PERCENT" -v thresh="${{ env.COVERAGE_THRESHOLD }}" 'BEGIN {print (cov < thresh)}') -eq 1 ]; then
            echo "âŒ Coverage ($COVERAGE_PERCENT%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
            exit 1
          else
            echo "âœ… Coverage ($COVERAGE_PERCENT%) meets threshold (${{ env.COVERAGE_THRESHOLD }}%)"
          fi
      - name: Generate gcov files for Sonar
        if: matrix.build-type == 'Debug'
        run: |
          cd build
          find . -type f -name '*.gcno' -execdir gcov -p {} \; 2>/dev/null || true
          mkdir -p ../coverage-reports/gcov
          find . -name '*.gcov' -exec mv {} ../coverage-reports/gcov/ \;

      - name: SonarCloud Scan
        if: matrix.build-type == 'Debug'
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_HOST_URL: https://sonarcloud.io
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload Coverage Reports
        if: matrix.build-type == 'Debug'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            build/coverage_html/
            build/coverage.xml
            build/coverage.info
            coverage-reports/gcov/
            build/compile_commands.json

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}-${{ matrix.build-type }}
          path: build/Testing/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Security Scan
        run: |
          echo "Running basic security checks..."
          # Check for common security issues in C++ code
          find src include -name "*.cpp" -o -name "*.hpp" | xargs grep -l "strcpy\|strcat\|sprintf" || echo "No obvious security issues found"

          # Check for hardcoded credentials
          grep -r "password\|secret\|key" src include || echo "No obvious hardcoded credentials found"
  report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [lint, build, security-scan]
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: coverage-reports/

      - name: Download Linting Reports
        uses: actions/download-artifact@v4
        with:
          name: linting-report-${{ github.run_number }}
          path: linting-reports/

      - name: Generate Summary
        run: |
          echo "# CI/CD Pipeline Summary" > summary.md
          echo "## Build Status" >> summary.md
          echo "- Linting: ${{ needs.lint.result }}" >> summary.md
          echo "- Build: ${{ needs.build.result }}" >> summary.md
          echo "- Security: ${{ needs.security-scan.result }}" >> summary.md

          if [ -f "coverage-reports/coverage.xml" ]; then
            echo "## Coverage Report" >> summary.md
            echo "Coverage report is available in the artifacts." >> summary.md
          fi

          if [ -d "linting-reports/" ]; then
            echo "## Linting Report" >> summary.md
            echo "Linting report is available in the artifacts." >> summary.md
          fi

      - name: Upload Summary Report
        uses: actions/upload-artifact@v4
        with:
          name: summary-report-${{ github.run_number }}
          path: summary.md
  image-generation:
    name: Image Generation
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/algogators/trade-ngin-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    needs: [lint, build, security-scan]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and Push Image
        shell: bash
        run: |
          pwd
          REPO="ghcr.io/${GITHUB_REPOSITORY,,}"            # lowercase owner/repo
          BRANCH="${GITHUB_REF#refs/heads/}"
          BRANCH_SAFE=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]')
          DATE=$(date +%Y%m%d)
          TIME=$(date +%H%M%S)
          TAG="${BRANCH_SAFE}-${DATE}-${TIME}"

          docker build -t "${REPO}:${TAG}" .
          docker push "${REPO}:${TAG}"
